name: Debug Credentials

on:
  workflow_dispatch:

jobs:
  debug:
    name: Debug AWS Credentials
    runs-on: ubuntu-latest

    steps:
      - name: Check test secret
        run: |
          echo "Testing simple secret: TEST_SECRET"
          if [ -n "${{ secrets.TEST_SECRET }}" ]; then
            echo "✓ TEST_SECRET is available: ${{ secrets.TEST_SECRET }}"
          else
            echo "✗ TEST_SECRET is NOT available"
          fi

      - name: Check secret availability
        run: |
          echo "Checking if secrets are available..."
          if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "✓ AWS_ACCESS_KEY_ID is set (length: ${#AWS_ACCESS_KEY_ID})"
            echo "  Value starts with: ${AWS_ACCESS_KEY_ID:0:8}..."
          else
            echo "✗ AWS_ACCESS_KEY_ID is NOT set"
          fi

          if [ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "✓ AWS_SECRET_ACCESS_KEY is set"
          else
            echo "✗ AWS_SECRET_ACCESS_KEY is NOT set"
          fi

          if [ -n "${{ secrets.AWS_SESSION_TOKEN }}" ]; then
            echo "✓ AWS_SESSION_TOKEN is set (length: ${#AWS_SESSION_TOKEN})"
            echo "  Value starts with: ${AWS_SESSION_TOKEN:0:20}..."
          else
            echo "✗ AWS_SESSION_TOKEN is NOT set"
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}

      - name: Try manual credential configuration
        run: |
          echo "Testing manual AWS CLI configuration..."
          export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          export AWS_SESSION_TOKEN="${{ secrets.AWS_SESSION_TOKEN }}"
          export AWS_DEFAULT_REGION="eu-west-2"

          aws sts get-caller-identity || echo "✗ Failed to authenticate"

      - name: Try aws-actions/configure-aws-credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: eu-west-2

      - name: Verify credentials after action
        run: |
          echo "Verifying after aws-actions/configure-aws-credentials..."
          aws sts get-caller-identity
